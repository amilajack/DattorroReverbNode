<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>WebAudio Dattorro</title>
	<style type="text/css">
		* {	font-family: sans-serif; }
		label, input+span { font-family: monospace; font-size: 2ex; line-height: 2.2ex;}
		input { height: 2.2ex; }
		body {
			margin: 20px auto;
			max-width: 800px;
			padding: 5px;
		}
		div>label {
			width: 33%;
			display: inline-block;
		}
		#controls>div {
			display: flex;
			align-items:center;
		}
	</style>
</head>
<body>
<button id="b1">Play kikuo.wav</button> <button id="b2">Play kikuo2.wav</button>
<br><br>
<div id="controls">
	<div>
		<label>PreLPF _______(🔻 0 ⬅&nbsp;&nbsp;➡ 1 🔺): </label> 
		<input type="range" id="bw" name="bandwidth" max="1" step="0.0001">
		<span id="bwv"></span>
	</div>
	<div>
		<label>PreDiffuse1 __(👎 0 ⬅👍➡ 1 👎): </label> 
		<input type="range" id="fi" name="inputDiffusion1" max="1" step="0.0001">
		<span id="fiv"></span>
	</div>
	<div>
		<label>PreDiffuse2___(👎 0 ⬅👍➡ 1 👎): </label> 
		<input type="range" id="si" name="inputDiffusion2" max="1" step="0.0001">
		<span id="siv"></span>
	</div>
	<div>
		<label>DecayRate_____(📉 0 ⬅&nbsp;&nbsp;➡ 1 🍨): </label> 
		<input type="range" id="dc" name="decay" min="0" max="1" step="0.0001"> 
		<span id="dcv"></span>
	</div>
	<div>
		<label>DecayDiffuse__(👎 0 ⬅👍➡ 1 👎): </label> 
		<input type="range" id="ft" name="decayDiffusion1" max="0.999999" step="0.0001">
		<span id="ftv"></span>
	</div>
	<div>
		<label>DecayDiffuse2_(👎 0 ⬅👍➡ 1 👎): </label> 
		<input type="range" id="st" name="decayDiffusion2" max="0.999999" step="0.0001">
		<span id="stv"></span>
	</div>
	<div>
		<label>Damping_______(👻 0 ⬅&nbsp;&nbsp;➡ 1 📉): </label> 
		<input type="range" id="dp" name="damping" max="1" step="0.0001">
		<span id="dpv"></span>
	</div>
	<div>
		<label>Dry___________(🔻 0 ⬅&nbsp;&nbsp;➡ 1 🔺): </label> 
		<input type="range" id="dr" name="dry" max="1" step="0.0001">
		<span id="drv"></span>
	</div>
	<div>
		<label>Wet___________(🔻 0 ⬅&nbsp;&nbsp;➡ 1 🔺): </label> 
		<input type="range" id="we" name="wet" max="1" step="0.0001" >
		<span id="wev"></span> 
	</div>
	<br>
	<div>
		<label>😷 Presets</label>
		<button id="smol">roomy owo</button> 
		<button id="bige">churchy uwu</button>
		<button id="frez">freezy ewe</button>
	</div>
</div>

<div>
	<h2>
		dattorro's reverb 📣
	</h2>
	<h4>
		an (almost) faithful implementation in AudioWorklet. flexible &mdash; freezable &mdash; fast &mdash; free! 
	</h4>
	<p>
		💪 flexible (compared to ConvolverNode) <br>
		🍨 freezable (just set decay to 1!) <br>
		🚅 fast (less than 100 μs each .process() on my machine on battery saving)<br>
		🆓 free!! (freeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee in so many ways)
	</p>
	<h3>📃 papers papers papers</h3>
	<ul>
		<li>AudioWorklet spec [<a href="https://webaudio.github.io/web-audio-api/#audioworklet">winky linky</a>]</li>
		<li>Jon Dattorro's paper [<a href="https://ccrma.stanford.edu/~dattorro/EffectDesignPart1.pdf">pdf linky</a>]</li>
	</ul>

	<h3>🎼 music music music</h3>
	<p>both clips are from Kikuo's Mikukikuo5 under CC BY-NC-SA: former - short fast sounds; latter - pitched.</p>
	<ul>
		<li>カラカラカラのカラ / Kara Kara Kara no Kara [<a href="https://kikuo.bandcamp.com/track/kara-kara-kara-no-kara">Bandcamp</a>]</li>
		<li>MAWARU [<a href="https://kikuo.bandcamp.com/track/mawaru">Bandcamp</a>]</li>
		<li>Sea is [<a href="https://kikuo.bandcamp.com/track/sea-is">Bandcamp</a>]</li>
	</ul>

	<h3>✅ todo todo todo</h3>
	<ul>
		<li>add excursion (assess performance first)</li>
		<li>add predelay</li>
		<li>add microphone input to demo</li>
	</ul>

	<h3>⚖ license &amp; 💾 source</h3>
	<p> public domain // [<a href="https://github.com/khoin/DattorroReverbNode">repo</a>]</p>
</div>
</body>
<script type="module">
const 	aC  = new AudioContext();
const 	w1  = new Audio('./kikuo.wav'),
		w2  = new Audio('./kikuo2.wav');

const 	presets = [
	[ 0.5683, 0.4666, 0.5853, 0.3226, 0.6954, 0.6022, 0.6446, 0.4921, 0.6361 ],
	[ 0.928 , 0.7331, 0.4534, 0.8771, 0.7839, 0.1992, 0.5975, 0.0042, 0.9619 ],
	[ 0.999 , 0.75  , 0.625 , 1     , 0.5   , 0.711 , 0.195 , 0.915 , 0.194  ]
];

aC.audioWorklet.addModule('dattorroReverb.js').then(_ => {
	let k1 = aC.createMediaElementSource(w1);
	let k2 = aC.createMediaElementSource(w2);

	let reverb = new AudioWorkletNode(aC, 'DattorroReverb');
	
	k1.connect(reverb);
	k2.connect(reverb);
	reverb.connect(aC.destination);

	b1.onclick = _ => aC.resume() & w1.play();
	b2.onclick = _ => aC.resume() & w2.play();

	const pull = _ => 
		[...document.querySelectorAll("input")]
			.forEach(r => r.nextElementSibling.innerText = r.value = reverb.parameters.get(r.name).value);

	const push = _ =>
		[...document.querySelectorAll("input")]
			.forEach(r => reverb.parameters.get(r.name).linearRampToValueAtTime(r.value, aC.currentTime+0.005));

	[...document.querySelectorAll("input")]
		.forEach(r => r.onmousemove = e => push() & pull());

	[smol, bige, frez]
		.forEach((b, i) => 
			b.onclick = e => {
				[bw, fi, si, dc, ft, st, dp, dr, we].forEach((p, j) => p.value = presets[i][j]);
				push();
				setTimeout(pull, 200);
			});

	pull();

}, e => {
	console.error(e);
});
</script>
</html>