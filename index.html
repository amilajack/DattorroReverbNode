<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>WebAudio Dattorro</title>
	<style type="text/css">
		* {
			font-family: sans-serif;
		}
		body {
			margin: 20px auto;
			max-width: 800px;
			padding: 5px;
		}
		div>label {
			width: 33%;
			display: inline-block;
		}
	</style>
</head>
<body>
<button id="play">Play Kikuo1.wav</button> <button id="play2">Play Kikuo2.wav</button>
<br>
<div id="controls">
	<div>
		<label>PreLP (0-1 no lp): </label> 
		<input type="range" id="bw" name="bandwidth" max="1" step="0.0001">
		<span id="bwv"></span>
	</div>
	<div>
		<label>PreDiffuse (more 0-1 less): </label> 
		<input type="range" id="fi" name="inputDiffusion1" max="1" step="0.0001">
		<span id="fiv"></span>
	</div>
	<div>
		<label>PreDiffuse2 (more 0-1 less): </label> 
		<input type="range" id="si" name="inputDiffusion2" max="1" step="0.0001">
		<span id="siv"></span>
	</div>
	<div>
		<label>Decay (fast 0-1 freeze): </label> 
		<input type="range" id="dc" name="decay" min="0" max="1" step="0.0001"> 
		<span id="dcv"></span>
	</div>
	<div>
		<label>DecayDiffuse (more 0-1 less): </label> 
		<input type="range" id="fd" name="decayDiffusion1" max="1" step="0.0001">
		<span id="fdv"></span>
	</div>
	<div>
		<label>DecayDiffuse2 (more 0-1 less): </label> 
		<input type="range" id="sd" name="decayDiffusion2" max="1" step="0.0001">
		<span id="sdv"></span>
	</div>
	<div>
		<label>Damping (less 0-1 more): </label> 
		<input type="range" id="dp" name="damping" max="1" step="0.0001">
		<span id="dpv"></span>
	</div>
	<div>
		<label>Dry (less 0-1 more): </label> 
		<input type="range" id="dr" name="dry" max="1" step="0.0001">
		<span id="drv"></span>
	</div>
	<div>
		<label>Wet (less 0-1 more): </label> 
		<input type="range" id="we" name="wet" max="1" step="0.0001" >
		<span id="wev"></span> 
	</div>
</div>

<div>
	<h2>
		(In Progress) Dattorro's 🍽 Reverb Implemented in AudioWorklet 📢
	</h2>
	<p>
		a (hopefully) faithful implementation of Dattorro's reverb in WebAudio AudioWorklet. <br>
		this would be a more flexible reverb compared to ConvolverNode. <br>
		it also allows you to freeze the reverb! (it sounds bad right now because you can hear the "repeats") <br>
		i previously implemented this reverb in SuperCollider which was easier having a cubic allpass at hand.
	</p>
	<h3>📃 papers & documents</h3>
	<ul>
		<li>Spec for AudioWorklet [<a href="https://webaudio.github.io/web-audio-api/#audioworklet">link</a>]</li>
		<li>Dattorro's Paper [<a href="https://ccrma.stanford.edu/~dattorro/EffectDesignPart1.pdf">pdf linky</a>]</li>
		<li>Good page to quickly refer to; from Hongchan [<a href="https://developers.google.com/web/updates/2017/12/audio-worklet">link</a>]</li>
	</ul>

	<h3>🎼 music</h3>
	<p>The two clips are from Kikuo's Mikukikuo5 they are both under CC BY-NC-SA. Second-clip has reverb already, but they're subtle enough that I figured it could be a good example</p>
	<ul>
		<li>カラカラカラのカラ / Kara Kara Kara no Kara [<a href="https://kikuo.bandcamp.com/track/kara-kara-kara-no-kara">Bandcamp</a>]</li>
		<li>MAWARU [<a href="https://kikuo.bandcamp.com/track/mawaru">bandcamp</a>]</li>
		<li>
六角六片三角孔ねじれ正多面体ですか？ / Is it six​-​hexagon skew polyhedron? [<a href="https://kikuo.bandcamp.com/track/is-it-six-hexagon-skew-polyhedron">Bandcamp</a>]</li>
	</ul>

	<h3>✔ stuff for me to do</h3>
	<ul>
		<li>Optimization: Convert all delay times wrt sampleRate instead of sampleRate/29761 (from paper)</li>
		<li>Optimization: Taps. Currently, they use .readDelayAt at every sample, which I think is quite costly.</li>
		<li>Feature: Excursion. The paper suggested this and was skipped.</li>
		<li>Considerations: There are some "repeats/flutters" audible at times. I believe this is because I rounded the delay times. I could switch to floating delay times, which means I'll have to implement delay interpolation. 🤔</li>
	</ul>

	<h3> ❔ try presets </h3>
	<p>
		<button id="smol">roomy</button>
	</p>
</div>
</body>
<script type="module">
	window.onload = () => {
		let aC = new AudioContext();
		let a  = new Audio('./kikuo.wav');
		let b = new Audio('./kikuo2.wav');
		
		aC.audioWorklet.addModule('process.js').then(() => {
			let aud = aC.createMediaElementSource(a);
			let aud2 = aC.createMediaElementSource(b);

			let proc = new AudioWorkletNode(aC, 'process');
			
			aud.connect(proc);
			aud2.connect(proc);
			proc.connect(aC.destination);

			play.onclick = () => {
				aC.resume();
				a.play();
			}
			play2.onclick = () => {
				aC.resume();
				b.play();
			}

			let pull = () => {
				[...document.querySelectorAll("input")].forEach(r => {
					r.value = proc.parameters.get(r.name).value;
				})
			}
			pull();

			let push = () => {
				[...document.querySelectorAll("input")].forEach(r => {
					proc.parameters.get(r.name).linearRampToValueAtTime(r.value, aC.currentTime+0.005);
					r.nextElementSibling.innerText = proc.parameters.get(r.name).value;
				})
			}

			[...document.querySelectorAll("input")].forEach(r => {
				r.onmousemove = e => {
					push();
				}
			})

			smol.onclick = e => {
				bw.value = 0.5683000087738037;
				fi.value = 0.4666000008583069;
				si.value = 0.5853000283241272;
				dc.value = 0.32260000705718994;
				fd.value = 0.6953999996185303;
				sd.value = 0.6021999716758728;
				dp.value = 0.644599974155426;
				dr.value = 0.4921000003814697;
				we.value = 0.6360999941825867;
				push();
				pull();
			}

		},e => {
			console.error(e);
		});
	}

</script>
</html>